{% extends "base.html" %}
{% block title %}Quáº£n trá»‹ - MANI Learning Hub{% endblock %}
{% block content %}
<h2 style="color:var(--primary);margin-bottom:16px">âš™ï¸ Quáº£n trá»‹ / Admin Panel</h2>
<div class="stats-grid">
    <div class="stat-card" style="border-top:4px solid var(--primary)"><div class="emoji">ğŸ‘¥</div><div class="num">{{ stats.total_users }}</div><div class="label">NgÆ°á»i dÃ¹ng</div></div>
    <div class="stat-card" style="border-top:4px solid var(--secondary)"><div class="emoji">ğŸ“š</div><div class="num">{{ stats.total_courses }}</div><div class="label">KhÃ³a há»c</div></div>
    <div class="stat-card" style="border-top:4px solid #28A745"><div class="emoji">ğŸ†</div><div class="num">{{ stats.total_certs }}</div><div class="label">Chá»©ng chá»‰</div></div>
    <div class="stat-card" style="border-top:4px solid var(--yellow)"><div class="emoji">ğŸ“</div><div class="num">{{ stats.total_attempts }}</div><div class="label">LÆ°á»£t thi</div></div>
</div>
<div class="tabs">
    <a href="#users" class="active" onclick="showAT('users',this)" id="tl-users">ğŸ‘¥ NgÆ°á»i dÃ¹ng</a>
    <a href="#content" onclick="showAT('content',this)" id="tl-content">ğŸ“‹ Ná»™i dung</a>
    <a href="#remind" onclick="showAT('remind',this)" id="tl-remind">ğŸ“§ Nháº¯c nhá»Ÿ</a>
</div>

<!-- USERS TAB -->
<div id="at-users" class="atab">
    <div class="card" style="padding:0;overflow:hidden"><div class="table-wrap"><table>
        <thead><tr><th>TÃªn</th><th>Email</th><th>PhÃ²ng ban</th><th>Vai trÃ²</th><th>Tráº¡ng thÃ¡i</th><th>Thao tÃ¡c</th></tr></thead>
        <tbody>
        {% for u in users %}
        <tr>
            <td><strong>{{ u['name'] }}</strong></td>
            <td style="font-size:11px;word-break:break-all">{{ u['email'] }}</td>
            <td><span class="tag">{{ u['department'] }}</span></td>
            <td><span class="badge badge-{{ u['role'] }}">{{ u['role'] }}</span></td>
            <td>{% if u['verified'] %}<span class="badge badge-success">âœ“</span>{% else %}<span class="badge badge-warning">â³</span>{% endif %}</td>
            <td><button class="btn btn-outline btn-sm" onclick="openEU({{ u['id'] }},'{{ u['department'] }}','{{ u['role'] }}','{{ u['status'] or 'active' }}','{{ u['name'] }}')">âœï¸</button></td>
        </tr>
        {% endfor %}
        </tbody>
    </table></div></div>
</div>

<!-- CONTENT TAB -->
<div id="at-content" class="atab" style="display:none">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
        <h3 style="color:var(--primary);font-size:16px">Quáº£n lÃ½ khÃ³a há»c</h3>
        <a href="{{ url_for('new_course') }}" class="btn btn-primary">â• ThÃªm khÃ³a há»c</a>
    </div>
    {% for c in courses %}
    <div class="card" style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;padding:14px">
        <div style="flex:1;min-width:180px">
            <div style="display:flex;gap:4px;margin-bottom:4px;flex-wrap:wrap">
                <span class="tag">{{ c['category'] }}</span>
                <span class="badge badge-info" style="font-size:10px">{{ q_counts.get(c['id'],0) }} cÃ¢u há»i</span>
                <span class="badge badge-info" style="font-size:10px">Láº¥y {{ c['quiz_count'] or q_counts.get(c['id'],0) }}</span>
            </div>
            <h4 style="margin:4px 0;color:var(--primary);font-size:14px">{{ c['title_vi'] or c['title_en'] }}</h4>
            {% set groups = c['target_groups'] | from_json %}
            {% if groups %}<div style="display:flex;gap:3px;flex-wrap:wrap;margin-top:3px">{% for g in groups %}<span style="font-size:9px;background:#f0f0f0;padding:1px 6px;border-radius:8px;color:#666">{{ g }}</span>{% endfor %}</div>{% endif %}
        </div>
        <div style="display:flex;gap:6px;flex-wrap:wrap">
            <a href="{{ url_for('manage_questions',cid=c['id']) }}" class="btn btn-secondary btn-sm">ğŸ“ CÃ¢u há»i</a>
            <a href="{{ url_for('edit_course',cid=c['id']) }}" class="btn btn-outline btn-sm">âœï¸ Sá»­a</a>
            <form method="POST" action="{{ url_for('delete_course',cid=c['id']) }}" style="display:inline" onsubmit="return confirm('XÃ³a khÃ³a há»c nÃ y?')"><button type="submit" class="btn btn-danger btn-sm">ğŸ—‘</button></form>
        </div>
    </div>
    {% endfor %}
    {% if courses|length == 0 %}<div class="card" style="text-align:center;color:#888;padding:28px">ChÆ°a cÃ³ khÃ³a há»c.</div>{% endif %}
</div>

<!-- REMINDER TAB -->
<div id="at-remind" class="atab" style="display:none">
    <div class="card">
        <h3 style="color:var(--primary);margin-bottom:14px;font-size:16px">ğŸ“§ Gá»­i nháº¯c nhá»Ÿ hoÃ n thÃ nh khÃ³a há»c</h3>
        <form method="POST" action="{{ url_for('send_reminder') }}">
            <div class="form-group">
                <label>Chá»n khÃ³a há»c *</label>
                <select name="course_id" class="form-control" required>
                    <option value="">-- Chá»n khÃ³a há»c --</option>
                    {% for c in courses %}<option value="{{ c['id'] }}">{{ c['title_vi'] or c['title_en'] }}</option>{% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label>Gá»­i Ä‘áº¿n</label>
                <select name="target_type" class="form-control" id="rem-type" onchange="toggleRemTarget()">
                    <option value="all">Táº¥t cáº£ nhÃ¢n viÃªn</option>
                    <option value="department">Theo phÃ²ng ban</option>
                    <option value="individual">CÃ¡ nhÃ¢n (email)</option>
                </select>
            </div>
            <div class="form-group" id="rem-dept" style="display:none">
                <label>PhÃ²ng ban</label>
                <select name="target_value" class="form-control" id="rem-dept-val">
                    {% for d in departments %}<option value="{{ d }}">{{ d }}</option>{% endfor %}
                </select>
            </div>
            <div class="form-group" id="rem-email" style="display:none">
                <label>Email cÃ¡ nhÃ¢n</label>
                <input type="email" name="target_value" class="form-control" id="rem-email-val" placeholder="email@manimedicalhanoi.com">
            </div>
            <div class="form-group">
                <label>Ná»™i dung nháº¯c nhá»Ÿ</label>
                <textarea name="message" class="form-control" rows="3">Vui lÃ²ng hoÃ n thÃ nh bÃ i Ä‘Ã o táº¡o vÃ  bÃ i test Ä‘Ãºng háº¡n. / Please complete the training and test on time.</textarea>
            </div>
            <button type="submit" class="btn btn-primary" onclick="return confirm('Gá»­i nháº¯c nhá»Ÿ?')">ğŸ“§ Gá»­i nháº¯c nhá»Ÿ / Send Reminder</button>
        </form>
    </div>
</div>

<!-- EDIT USER MODAL -->
<div id="eu-modal" class="modal-overlay" onclick="if(event.target===this)closeEU()">
    <div class="modal-box">
        <h3 style="color:var(--primary);margin-bottom:16px">Chá»‰nh sá»­a: <span id="eu-name"></span></h3>
        <form method="POST" id="eu-form">
            <div class="form-group"><label>PhÃ²ng ban</label><select name="department" id="eu-dept" class="form-control">{% for d in departments %}<option value="{{ d }}">{{ d }}</option>{% endfor %}</select></div>
            <div class="form-group"><label>Vai trÃ²</label><select name="role" id="eu-role" class="form-control"><option value="learner">Learner (Há»c viÃªn)</option><option value="trainer">Trainer (ÄÃ o táº¡o viÃªn)</option>{% if user['role']=='admin' %}<option value="admin">Admin</option>{% endif %}</select></div>
            <div class="form-group"><label>Tráº¡ng thÃ¡i</label><select name="status" id="eu-status" class="form-control"><option value="active">Active</option><option value="inactive">Inactive</option></select></div>
            <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:16px">
                <button type="button" onclick="closeEU()" class="btn btn-outline">Há»§y</button>
                <button type="submit" class="btn btn-primary">ğŸ’¾ LÆ°u</button>
            </div>
        </form>
    </div>
</div>

<script>
function showAT(n,el){document.querySelectorAll('.atab').forEach(t=>t.style.display='none');document.querySelectorAll('.tabs a').forEach(a=>a.classList.remove('active'));document.getElementById('at-'+n).style.display='block';el.classList.add('active')}
if(location.hash==='#content')showAT('content',document.getElementById('tl-content'));
if(location.hash==='#remind')showAT('remind',document.getElementById('tl-remind'));
function openEU(id,dept,role,status,name){document.getElementById('eu-form').action='/admin/user/'+id+'/update';document.getElementById('eu-dept').value=dept;document.getElementById('eu-role').value=role;document.getElementById('eu-status').value=status||'active';document.getElementById('eu-name').textContent=name;document.getElementById('eu-modal').classList.add('show')}
function closeEU(){document.getElementById('eu-modal').classList.remove('show')}
function toggleRemTarget(){
    var v=document.getElementById('rem-type').value;
    document.getElementById('rem-dept').style.display=v==='department'?'block':'none';
    document.getElementById('rem-email').style.display=v==='individual'?'block':'none';
    // Sync the name attribute: only one target_value should be active
    if(v==='department'){document.getElementById('rem-dept-val').name='target_value';document.getElementById('rem-email-val').name='_tv2'}
    else if(v==='individual'){document.getElementById('rem-email-val').name='target_value';document.getElementById('rem-dept-val').name='_tv1'}
    else{document.getElementById('rem-dept-val').name='_tv1';document.getElementById('rem-email-val').name='_tv2'}
}
toggleRemTarget();
</script>
{% endblock %}
