{% extends "base.html" %}
{% block title %}Thá»‘ng kÃª - MANI Learning Hub{% endblock %}
{% block content %}
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:12px">
    <h2 style="color:var(--primary);margin:0">ğŸ“Š Thá»‘ng kÃª & BÃ¡o cÃ¡o / Analytics</h2>
    <a href="{{ url_for('export_csv') }}" class="btn btn-primary">ğŸ“¥ Xuáº¥t CSV / Export</a>
</div>

<!-- Department Stats -->
<div class="card" style="margin-bottom:24px">
    <h3 style="color:var(--primary);margin-bottom:16px">Thá»‘ng kÃª theo phÃ²ng ban / Department Statistics</h3>
    {% for dept, stat in dept_stats.items() %}
    {% if stat.users > 0 %}
    <div style="margin-bottom:20px">
        <div style="display:flex;justify-content:space-between;margin-bottom:4px;font-size:14px">
            <span style="font-weight:600">{{ dept }} ({{ stat.users }} ngÆ°á»i)</span>
            <span style="color:var(--secondary);font-weight:600">{{ stat.rate }}%</span>
        </div>
        <div class="progress-bar">
            <div class="progress-fill" style="width:{{ stat.rate }}%"></div>
        </div>
        <div style="font-size:12px;color:#888;margin-top:4px">
            {{ stat.passed }} Ä‘áº¡t / {{ stat.attempts }} lÆ°á»£t thi
        </div>
    </div>
    {% endif %}
    {% endfor %}
    {% set has_data = false %}
    {% for dept, stat in dept_stats.items() %}{% if stat.users > 0 %}{% set has_data = true %}{% endif %}{% endfor %}
    {% if not has_data %}
    <p style="color:#888;text-align:center">ChÆ°a cÃ³ dá»¯ liá»‡u.</p>
    {% endif %}
</div>

<!-- User History -->
<div class="card" style="margin-bottom:24px">
    <h3 style="color:var(--primary);margin-bottom:16px">Lá»‹ch sá»­ Ä‘Ã o táº¡o / Training History</h3>
    <div class="form-group">
        <select id="user-filter" class="form-control" onchange="filterByUser(this.value)" style="max-width:400px">
            <option value="">-- Chá»n ngÆ°á»i dÃ¹ng / Select user --</option>
            {% for u in users_all %}
            <option value="{{ u['email'] }}">{{ u['name'] }} ({{ u['email'] }}) - {{ u['department'] }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="table-wrap">
        <table id="results-table">
            <thead>
                <tr>
                    <th>NgÆ°á»i dÃ¹ng</th>
                    <th>PhÃ²ng ban</th>
                    <th>KhÃ³a há»c</th>
                    <th>Äiá»ƒm</th>
                    <th>Káº¿t quáº£</th>
                    <th>NgÃ y</th>
                </tr>
            </thead>
            <tbody>
                {% for r in results %}
                <tr data-email="{{ r['user_email'] }}">
                    <td><strong>{{ r['name'] or r['user_email'] }}</strong></td>
                    <td><span class="tag">{{ r['department'] or '-' }}</span></td>
                    <td>{{ r['title_vi'] or r['title_en'] or '-' }}</td>
                    <td><strong>{{ r['score'] }}/{{ r['total'] }}</strong></td>
                    <td>
                        {% if r['passed'] %}
                        <span class="badge badge-success">âœ“ Äáº¡t</span>
                        {% else %}
                        <span class="badge badge-danger">âœ— KhÃ´ng Ä‘áº¡t</span>
                        {% endif %}
                    </td>
                    <td>{{ r['completed_at'][:16] }}</td>
                </tr>
                {% endfor %}
                {% if results|length == 0 %}
                <tr><td colspan="6" style="text-align:center;color:#888">ChÆ°a cÃ³ dá»¯ liá»‡u.</td></tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<!-- Course Stats -->
<div class="card">
    <h3 style="color:var(--primary);margin-bottom:16px">Thá»‘ng kÃª theo khÃ³a há»c / Course Statistics</h3>
    {% for c in courses %}
    {% set c_results = [] %}
    {% for r in results %}{% if r['course_id'] == c['id'] %}{% set _ = c_results.append(r) %}{% endif %}{% endfor %}
    {% set c_passed = [] %}
    {% for r in c_results %}{% if r['passed'] %}{% set _ = c_passed.append(r) %}{% endif %}{% endfor %}
    <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid #eee;flex-wrap:wrap;gap:8px">
        <div>
            <span class="tag">{{ c['category'] }}</span>
            <strong style="margin-left:8px;color:var(--primary)">{{ c['title_vi'] or c['title_en'] }}</strong>
        </div>
        <div style="display:flex;gap:12px;font-size:13px">
            <span>ğŸ“ {{ c_results|length }} lÆ°á»£t thi</span>
            <span style="color:var(--success)">âœ“ {{ c_passed|length }} Ä‘áº¡t</span>
            <span style="color:#888">
                {% if c_results|length > 0 %}{{ (c_passed|length / c_results|length * 100)|round }}%{% else %}0%{% endif %}
            </span>
        </div>
    </div>
    {% endfor %}
</div>

<script>
function filterByUser(email) {
    const rows = document.querySelectorAll('#results-table tbody tr');
    rows.forEach(row => {
        if (!email || row.dataset.email === email) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}
</script>
{% endblock %}
